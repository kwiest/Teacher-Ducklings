(function(a){var b="autosave",c="restoredraft",d=!0,e,f,g=a.util.Dispatcher;a.create("tinymce.plugins.AutoSave",{init:function(h,i){function l(a){var b={s:1e3,m:6e4};return a=/^(\d+)([ms]?)$/.exec(""+a),(a[2]?b[a[2]]:1)*parseInt(a)}var j=this,k=h.settings;j.editor=h,a.each({ask_before_unload:d,interval:"30s",retention:"20m",minlength:50},function(a,c){c=b+"_"+c,k[c]===e&&(k[c]=a)}),k.autosave_interval=l(k.autosave_interval),k.autosave_retention=l(k.autosave_retention),h.addButton(c,{title:b+".restore_content",onclick:function(){h.getContent({draft:!0}).replace(/\s|&nbsp;|<\/?p[^>]*>|<br[^>]*>/gi,"").length>0?h.windowManager.confirm(b+".warning_message",function(a){a&&j.restoreDraft()}):j.restoreDraft()}}),h.onNodeChange.add(function(){var a=h.controlManager;a.get(c)&&a.setDisabled(c,!j.hasDraft())}),h.onInit.add(function(){h.controlManager.get(c)&&(j.setupStorage(h),setInterval(function(){j.storeDraft(),h.nodeChanged()},k.autosave_interval))}),j.onStoreDraft=new g(j),j.onRestoreDraft=new g(j),j.onRemoveDraft=new g(j),f||(window.onbeforeunload=a.plugins.AutoSave._beforeUnloadHandler,f=d)},getInfo:function(){return{longname:"Auto save",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/autosave",version:a.majorVersion+"."+a.minorVersion}},getExpDate:function(){return(new Date((new Date).getTime()+this.editor.settings.autosave_retention)).toUTCString()},setupStorage:function(c){var e=this,f=b+"_test",g="OK";e.key=b+c.id,a.each([function(){if(localStorage){localStorage.setItem(f,g);if(localStorage.getItem(f)===g)return localStorage.removeItem(f),localStorage}},function(){if(sessionStorage){sessionStorage.setItem(f,g);if(sessionStorage.getItem(f)===g)return sessionStorage.removeItem(f),sessionStorage}},function(){if(a.isIE)return c.getElement().style.behavior="url('#default#userData')",{autoExpires:d,setItem:function(a,b){var d=c.getElement();d.setAttribute(a,b),d.expires=e.getExpDate();try{d.save("TinyMCE")}catch(f){}},getItem:function(a){var b=c.getElement();try{return b.load("TinyMCE"),b.getAttribute(a)}catch(d){return null}},removeItem:function(a){c.getElement().removeAttribute(a)}}}],function(a){try{e.storage=a();if(e.storage)return!1}catch(b){}})},storeDraft:function(){var a=this,b=a.storage,c=a.editor,d,e;if(b){if(!b.getItem(a.key)&&!c.isDirty())return;e=c.getContent({draft:!0}),e.length>c.settings.autosave_minlength&&(d=a.getExpDate(),a.storage.autoExpires||a.storage.setItem(a.key+"_expires",d),a.storage.setItem(a.key,e),a.onStoreDraft.dispatch(a,{expires:d,content:e}))}},restoreDraft:function(){var a=this,b=a.storage,c;b&&(c=b.getItem(a.key),c&&(a.editor.setContent(c),a.onRestoreDraft.dispatch(a,{content:c})))},hasDraft:function(){var a=this,b=a.storage,c,e;if(b){e=!!b.getItem(a.key);if(e){if(!!a.storage.autoExpires)return d;c=new Date(b.getItem(a.key+"_expires"));if((new Date).getTime()<c.getTime())return d;a.removeDraft()}}return!1},removeDraft:function(){var a=this,b=a.storage,c=a.key,d;b&&(d=b.getItem(c),b.removeItem(c),b.removeItem(c+"_expires"),d&&a.onRemoveDraft.dispatch(a,{content:d}))},"static":{_beforeUnloadHandler:function(b){var c;return a.each(tinyMCE.editors,function(a){a.plugins.autosave&&a.plugins.autosave.storeDraft();if(a.getParam("fullscreen_is_enabled"))return;!c&&a.isDirty()&&a.getParam("autosave_ask_before_unload")&&(c=a.getLang("autosave.unload_msg"))}),c}}}),a.PluginManager.add("autosave",a.plugins.AutoSave)})(tinymce);