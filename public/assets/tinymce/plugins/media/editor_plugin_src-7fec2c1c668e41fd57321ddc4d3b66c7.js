/**
 * editor_plugin_src.js
 *
 * Copyright 2009, Moxiecode Systems AB
 * Released under LGPL License.
 *
 * License: http://tinymce.moxiecode.com/license
 * Contributing: http://tinymce.moxiecode.com/contributing
 */
(function(){function h(a){var b,c,d;if(a&&!a.splice){c=[];for(d=0;!0;d++){if(!a[d])break;c[d]=a[d]}return c}return a}var a=tinymce.explode("id,name,width,height,style,align,class,hspace,vspace,bgcolor,type"),b=tinymce.makeMap(a.join(",")),c=tinymce.html.Node,d,e,f=tinymce.util.JSON,g;d=[["Flash","d27cdb6e-ae6d-11cf-96b8-444553540000","application/x-shockwave-flash","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["ShockWave","166b1bca-3f9c-11cf-8075-444553540000","application/x-director","http://download.macromedia.com/pub/shockwave/cabs/director/sw.cab#version=8,5,1,0"],["WindowsMedia","6bf52a52-394a-11d3-b153-00c04f79faa6,22d6f312-b0f6-11d0-94ab-0080c74c7e95,05589fa1-c356-11ce-bf01-00aa0055595a","application/x-mplayer2","http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version=5,1,52,701"],["QuickTime","02bf25d5-8c17-4b23-bc80-d3488abddc6b","video/quicktime","http://www.apple.com/qtactivex/qtplugin.cab#version=6,0,2,0"],["RealMedia","cfcdaa03-8be4-11cf-b84b-0020afbbccfa","audio/x-pn-realaudio-plugin","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["Java","8ad9c840-044e-11d1-b3e9-00805f499d93","application/x-java-applet","http://java.sun.com/products/plugin/autodl/jinstall-1_5_0-windows-i586.cab#Version=1,5,0,0"],["Silverlight","dfeaf541-f3e1-4c24-acac-99c30715084a","application/x-silverlight-2"],["Iframe"],["Video"],["EmbeddedAudio"],["Audio"]],tinymce.create("tinymce.plugins.MediaPlugin",{init:function(b,c){function m(a){return a&&a.nodeName==="IMG"&&b.dom.hasClass(a,"mceItemMedia")}var g=this,h={},i,j,k,l;g.editor=b,g.url=c,e="";for(i=0;i<d.length;i++){l=d[i][0],k={name:l,clsids:tinymce.explode(d[i][1]||""),mimes:tinymce.explode(d[i][2]||""),codebase:d[i][3]};for(j=0;j<k.clsids.length;j++)h["clsid:"+k.clsids[j]]=k;for(j=0;j<k.mimes.length;j++)h[k.mimes[j]]=k;h["mceItem"+l]=k,h[l.toLowerCase()]=k,e+=(e?"|":"")+l}tinymce.each(b.getParam("media_types","video=mp4,m4v,ogv,webm;silverlight=xap;flash=swf,flv;shockwave=dcr;quicktime=mov,qt,mpg,mpeg;shockwave=dcr;windowsmedia=avi,wmv,wm,asf,asx,wmx,wvx;realmedia=rm,ra,ram;java=jar;audio=mp3,ogg").split(";"),function(a){var b,c,d;a=a.split(/=/),c=tinymce.explode(a[1].toLowerCase());for(b=0;b<c.length;b++)d=h[a[0].toLowerCase()],d&&(h[c[b]]=d)}),e=new RegExp("write("+e+")\\(([^)]+)\\)"),g.lookup=h,b.onPreInit.add(function(){b.schema.addValidElements("object[id|style|width|height|classid|codebase|*],param[name|value],embed[id|style|width|height|type|src|*],video[*],audio[*],source[*]"),b.parser.addNodeFilter("object,embed,video,audio,script,iframe",function(a){var b=a.length;while(b--)g.objectToImg(a[b])}),b.serializer.addNodeFilter("img",function(a,b,c){var d=a.length,e;while(d--)e=a[d],(e.attr("class")||"").indexOf("mceItemMedia")!==-1&&g.imgToObject(e,c)})}),b.onInit.add(function(){b.theme&&b.theme.onResolveName&&b.theme.onResolveName.add(function(a,c){c.name==="img"&&b.dom.hasClass(c.node,"mceItemMedia")&&(c.name="media")}),b&&b.plugins.contextmenu&&b.plugins.contextmenu.onContextMenu.add(function(a,b,c){c.nodeName==="IMG"&&c.className.indexOf("mceItemMedia")!==-1&&b.add({title:"media.edit",icon:"media",cmd:"mceMedia"})})}),b.addCommand("mceMedia",function(){var d,e;e=b.selection.getNode(),m(e)&&(d=b.dom.getAttrib(e,"data-mce-json"),d&&(d=f.parse(d),tinymce.each(a,function(a){var c=b.dom.getAttrib(e,a);c&&(d[a]=c)}),d.type=g.getType(e.className).name.toLowerCase())),d||(d={type:"flash",video:{sources:[]},params:{}}),b.windowManager.open({file:c+"/media.htm",width:430+parseInt(b.getLang("media.delta_width",0)),height:500+parseInt(b.getLang("media.delta_height",0)),inline:1},{plugin_url:c,data:d})}),b.addButton("media",{title:"media.desc",cmd:"mceMedia"}),b.onNodeChange.add(function(a,b,c){b.setActive("media",m(c))})},convertUrl:function(a,b){var c=this,d=c.editor,e=d.settings,f=e.url_converter,g=e.url_converter_scope||c;return a?b?d.documentBaseURI.toAbsolute(a):f.call(g,a,"src","object"):a},getInfo:function(){return{longname:"Media",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/media",version:tinymce.majorVersion+"."+tinymce.minorVersion}},dataToImg:function(a,b){var c=this,d=c.editor,e=d.documentBaseURI,g,i,j,k;a.params.src=c.convertUrl(a.params.src,b),i=a.video.attrs,i&&(i.src=c.convertUrl(i.src,b)),i&&(i.poster=c.convertUrl(i.poster,b)),g=h(a.video.sources);if(g)for(k=0;k<g.length;k++)g[k].src=c.convertUrl(g[k].src,b);return j=c.editor.dom.create("img",{id:a.id,style:a.style,align:a.align,hspace:a.hspace,vspace:a.vspace,src:c.editor.theme.url+"/img/trans.gif","class":"mceItemMedia mceItem"+c.getType(a.type).name,"data-mce-json":f.serialize(a,"'")}),j.width=a.width||(a.type=="audio"?"300":"320"),j.height=a.height||(a.type=="audio"?"32":"240"),j},dataToHtml:function(a,b){return this.editor.serializer.serialize(this.dataToImg(a,b),{forced_root_block:"",force_absolute:b})},htmlToData:function(b){var c,d,e;return e={type:"flash",video:{sources:[]},params:{}},c=this.editor.parser.parse(b),d=c.getAll("img")[0],d&&(e=f.parse(d.attr("data-mce-json")),e.type=this.getType(d.attr("class")).name.toLowerCase(),tinymce.each(a,function(a){var b=d.attr(a);b&&(e[a]=b)})),e},getType:function(a){var b,c,d;c=tinymce.explode(a," ");for(b=0;b<c.length;b++){d=this.lookup[c[b]];if(d)return d}},imgToObject:function(b,d){function B(a,b){var c,d,f,h,i;i=g.getParam("flash_video_player_url",e.convertUrl(e.url+"/moxieplayer.swf")),i&&(c=g.documentBaseURI,o.params.src=i,g.getParam("flash_video_player_absvideourl",!0)&&(a=c.toAbsolute(a||"",!0),b=c.toAbsolute(b||"",!0)),f="",d=g.getParam("flash_video_player_flashvars",{url:"$url",poster:"$poster"}),tinymce.each(d,function(c,d){c=c.replace(/\$url/,a||""),c=c.replace(/\$poster/,b||""),c.length>0&&(f+=(f?"&":"")+d+"="+escape(c))}),f.length&&(o.params.flashvars=f),h=g.getParam("flash_video_player_params",{allowfullscreen:!0,allowscriptaccess:!0}),tinymce.each(h,function(a,b){o.params[b]=""+a}))}var e=this,g=e.editor,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;o=b.attr("data-mce-json");if(!o)return;o=f.parse(o),t=this.getType(b.attr("class")),z=b.attr("data-mce-style"),z||(z=b.attr("style"),z&&(z=g.dom.serializeStyle(g.dom.parseStyle(z,"img"))));if(t.name==="Iframe"){x=new c("iframe",1),tinymce.each(a,function(a){var c=b.attr(a);a=="class"&&c&&(c=c.replace(/mceItem.+ ?/g,"")),c&&c.length>0&&x.attr(a,c)});for(m in o.params)x.attr(m,o.params[m]);x.attr({style:z,src:o.params.src}),b.replace(x);return}if(this.editor.settings.media_use_script){x=(new c("script",1)).attr("type","text/javascript"),n=new c("#text",3),n.value="write"+t.name+"("+f.serialize(tinymce.extend(o.params,{width:b.attr("width"),height:b.attr("height")}))+");",x.append(n),b.replace(x);return}if(t.name==="Video"&&o.video.sources[0]){i=(new c("video",1)).attr(tinymce.extend({id:b.attr("id"),width:b.attr("width"),height:b.attr("height"),style:z},o.video.attrs)),o.video.attrs&&(y=o.video.attrs.poster),q=o.video.sources=h(o.video.sources);for(u=0;u<q.length;u++)/\.mp4$/.test(q[u].src)&&(w=q[u].src);q[0].type||(i.attr("src",q[0].src),q.splice(0,1));for(u=0;u<q.length;u++)p=(new c("source",1)).attr(q[u]),p.shortEnded=!0,i.append(p);w?(B(w,y),t=e.getType("flash")):o.params.src=""}if(t.name==="Audio"&&o.video.sources[0]){A=(new c("audio",1)).attr(tinymce.extend({id:b.attr("id"),width:b.attr("width"),height:b.attr("height"),style:z},o.video.attrs)),o.video.attrs&&(y=o.video.attrs.poster),q=o.video.sources=h(o.video.sources),q[0].type||(A.attr("src",q[0].src),q.splice(0,1));for(u=0;u<q.length;u++)p=(new c("source",1)).attr(q[u]),p.shortEnded=!0,A.append(p);o.params.src=""}if(t.name==="EmbeddedAudio"){k=new c("embed",1),k.shortEnded=!0,k.attr({id:b.attr("id"),width:b.attr("width"),height:b.attr("height"),style:z,type:b.attr("type")});for(m in o.params)k.attr(m,o.params[m]);tinymce.each(a,function(a){o[a]&&a!="type"&&k.attr(a,o[a])}),o.params.src=""}if(o.params.src){/\.flv$/i.test(o.params.src)&&B(o.params.src,""),d&&d.force_absolute&&(o.params.src=g.documentBaseURI.toAbsolute(o.params.src)),j=(new c("object",1)).attr({id:b.attr("id"),width:b.attr("width"),height:b.attr("height"),style:z}),tinymce.each(a,function(a){var b=o[a];a=="class"&&b&&(b=b.replace(/mceItem.+ ?/g,"")),b&&a!="type"&&j.attr(a,b)});for(m in o.params)s=new c("param",1),s.shortEnded=!0,n=o.params[m],m==="src"&&t.name==="WindowsMedia"&&(m="url"),s.attr({name:m,value:n}),j.append(s);if(this.editor.getParam("media_strict",!0))j.attr({data:o.params.src,type:t.mimes[0]});else{j.attr({classid:"clsid:"+t.clsids[0],codebase:t.codebase}),k=new c("embed",1),k.shortEnded=!0,k.attr({id:b.attr("id"),width:b.attr("width"),height:b.attr("height"),style:z,type:t.mimes[0]});for(m in o.params)k.attr(m,o.params[m]);tinymce.each(a,function(a){o[a]&&a!="type"&&k.attr(a,o[a])}),j.append(k)}o.object_html&&(n=new c("#text",3),n.raw=!0,n.value=o.object_html,j.append(n)),i&&i.append(j)}i&&o.video_html&&(n=new c("#text",3),n.raw=!0,n.value=o.video_html,i.append(n)),A&&o.video_html&&(n=new c("#text",3),n.raw=!0,n.value=o.video_html,A.append(n));var C=i||A||j||k;C?b.replace(C):b.remove()},objectToImg:function(d){function H(a){return(new tinymce.html.Serializer({inner:!0,validate:!1})).serialize(a)}function I(a,b){return y[(a.attr(b)||"").toLowerCase()]}function J(a){var b=a.replace(/^.*\.([^.]+)$/,"$1");return y[b.toLowerCase()||""]}var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y=this.lookup,z,A,B=this.editor.settings.url_converter,C=this.editor.settings.url_converter_scope,D,E,F,G;if(!d.parent)return;if(d.name==="script"){d.firstChild&&(z=e.exec(d.firstChild.value));if(!z)return;x=z[1],w={video:{},params:f.parse(z[2])},n=w.params.width,o=w.params.height}w=w||{video:{},params:{}},k=new c("img",1),k.attr({src:this.editor.theme.url+"/img/trans.gif"}),l=d.name;if(l==="video"||l=="audio"){i=d,g=d.getAll("object")[0],h=d.getAll("embed")[0],n=i.attr("width"),o=i.attr("height"),m=i.attr("id"),w.video={attrs:{},sources:[]},A=w.video.attrs;for(l in i.attributes.map)A[l]=i.attributes.map[l];u=d.attr("src"),u&&w.video.sources.push({src:B.call(C,u,"src",d.name)}),v=i.getAll("source");for(q=0;q<v.length;q++)u=v[q].remove(),w.video.sources.push({src:B.call(C,u.attr("src"),"src","source"),type:u.attr("type"),media:u.attr("media")});A.poster&&(A.poster=B.call(C,A.poster,"poster",d.name))}d.name==="object"&&(g=d,h=d.getAll("embed")[0]),d.name==="embed"&&(h=d),d.name==="iframe"&&(j=d,x="Iframe");if(g){n=n||g.attr("width"),o=o||g.attr("height"),p=p||g.attr("style"),m=m||g.attr("id"),D=D||g.attr("hspace"),E=E||g.attr("vspace"),F=F||g.attr("align"),G=G||g.attr("bgcolor"),w.name=g.attr("name"),t=g.getAll("param");for(q=0;q<t.length;q++)s=t[q],l=s.remove().attr("name"),b[l]||(w.params[l]=s.attr("value"));w.params.src=w.params.src||g.attr("data")}if(h){n=n||h.attr("width"),o=o||h.attr("height"),p=p||h.attr("style"),m=m||h.attr("id"),D=D||h.attr("hspace"),E=E||h.attr("vspace"),F=F||h.attr("align"),G=G||h.attr("bgcolor");for(l in h.attributes.map)!b[l]&&!w.params[l]&&(w.params[l]=h.attributes.map[l])}if(j){n=j.attr("width"),o=j.attr("height"),p=p||j.attr("style"),m=j.attr("id"),D=j.attr("hspace"),E=j.attr("vspace"),F=j.attr("align"),G=j.attr("bgcolor"),tinymce.each(a,function(a){k.attr(a,j.attr(a))});for(l in j.attributes.map)!b[l]&&!w.params[l]&&(w.params[l]=j.attributes.map[l])}w.params.movie&&(w.params.src=w.params.src||w.params.movie,delete w.params.movie),w.params.src&&(w.params.src=B.call(C,w.params.src,"src","object")),i&&(d.name==="video"?x=y.video.name:d.name==="audio"&&(x=y.audio.name)),g&&!x&&(x=(I(g,"clsid")||I(g,"classid")||I(g,"type")||{}).name),h&&!x&&(x=(I(h,"type")||J(w.params.src)||{}).name),h&&x=="EmbeddedAudio"&&(w.params.type=h.attr("type")),d.replace(k),h&&h.remove(),g&&(r=H(g.remove()),r&&(w.object_html=r)),i&&(r=H(i.remove()),r&&(w.video_html=r)),w.hspace=D,w.vspace=E,w.align=F,w.bgcolor=G,k.attr({id:m,"class":"mceItemMedia mceItem"+(x||"Flash"),style:p,width:n||(d.name=="audio"?"300":"320"),height:o||(d.name=="audio"?"32":"240"),hspace:D,vspace:E,align:F,bgcolor:G,"data-mce-json":f.serialize(w,"'")})}}),tinymce.PluginManager.add("media",tinymce.plugins.MediaPlugin)})();