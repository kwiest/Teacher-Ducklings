/**
 * editor_plugin_src.js
 *
 * Copyright 2009, Moxiecode Systems AB
 * Released under LGPL License.
 *
 * License: http://tinymce.moxiecode.com/license
 * Contributing: http://tinymce.moxiecode.com/contributing
 */
(function(){var a=tinymce.util.JSONRequest,b=tinymce.each,c=tinymce.DOM;tinymce.create("tinymce.plugins.SpellcheckerPlugin",{getInfo:function(){return{longname:"Spellchecker",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/spellchecker",version:tinymce.majorVersion+"."+tinymce.minorVersion}},init:function(a,c){var d=this,e;d.url=c,d.editor=a,d.rpcUrl=a.getParam("spellchecker_rpc_url","{backend}");if(d.rpcUrl=="{backend}"){if(tinymce.isIE)return;d.hasSupport=!0,a.onContextMenu.addToTop(function(a,b){if(d.active)return!1})}a.addCommand("mceSpellCheck",function(){if(d.rpcUrl=="{backend}"){d.editor.getBody().spellcheck=d.active=!d.active;return}d.active?d._done():(a.setProgressState(1),d._sendRPC("checkWords",[d.selectedLang,d._getWords()],function(b){b.length>0?(d.active=1,d._markWords(b),a.setProgressState(0),a.nodeChanged()):(a.setProgressState(0),a.getParam("spellchecker_report_no_misspellings",!0)&&a.windowManager.alert("spellchecker.no_mpell"))}))}),a.settings.content_css!==!1&&a.contentCSS.push(c+"/css/content.css"),a.onClick.add(d._showMenu,d),a.onContextMenu.add(d._showMenu,d),a.onBeforeGetContent.add(function(){d.active&&d._removeWords()}),a.onNodeChange.add(function(a,b){b.setActive("spellchecker",d.active)}),a.onSetContent.add(function(){d._done()}),a.onBeforeGetContent.add(function(){d._done()}),a.onBeforeExecCommand.add(function(a,b){b=="mceFullScreen"&&d._done()}),d.languages={},b(a.getParam("spellchecker_languages","+English=en,Danish=da,Dutch=nl,Finnish=fi,French=fr,German=de,Italian=it,Polish=pl,Portuguese=pt,Spanish=es,Swedish=sv","hash"),function(a,b){b.indexOf("+")===0&&(b=b.substring(1),d.selectedLang=a),d.languages[b]=a})},createControl:function(a,c){var d=this,e,f=d.editor;if(a=="spellchecker")return d.rpcUrl=="{backend}"?(d.hasSupport&&(e=c.createButton(a,{title:"spellchecker.desc",cmd:"mceSpellCheck",scope:d})),e):(e=c.createSplitButton(a,{title:"spellchecker.desc",cmd:"mceSpellCheck",scope:d}),e.onRenderMenu.add(function(a,c){c.add({title:"spellchecker.langs","class":"mceMenuItemTitle"}).setDisabled(1),b(d.languages,function(a,b){var e={icon:1},f;e.onclick=function(){if(a==d.selectedLang)return;f.setSelected(1),d.selectedItem.setSelected(0),d.selectedItem=f,d.selectedLang=a},e.title=b,f=c.add(e),f.setSelected(a==d.selectedLang),a==d.selectedLang&&(d.selectedItem=f)})}),e)},_walk:function(a,b){var c=this.editor.getDoc(),d;if(c.createTreeWalker){d=c.createTreeWalker(a,NodeFilter.SHOW_TEXT,null,!1);while((a=d.nextNode())!=null)b.call(this,a)}else tinymce.walk(a,b,"childNodes")},_getSeparators:function(){var a="",b,c=this.editor.getParam("spellchecker_word_separator_chars",'\\s!"#$%&()*+,-./:;<=>?@[]^_{|}§©«®±¶·¸»¼½¾¿×÷¤”“');for(b=0;b<c.length;b++)a+="\\"+c.charAt(b);return a},_getWords:function(){var a=this.editor,c=[],d="",e={},f=[];return this._walk(a.getBody(),function(a){a.nodeType==3&&(d+=a.nodeValue+" ")}),a.getParam("spellchecker_word_pattern")?f=d.match("("+a.getParam("spellchecker_word_pattern")+")","gi"):(d=d.replace(new RegExp("([0-9]|["+this._getSeparators()+"])","g")," "),d=tinymce.trim(d.replace(/(\s+)/g," ")),f=d.split(" ")),b(f,function(a){e[a]||(c.push(a),e[a]=1)}),c},_removeWords:function(a){var c=this.editor,d=c.dom,e=c.selection,f=e.getBookmark();b(d.select("span").reverse(),function(b){b&&(d.hasClass(b,"mceItemHiddenSpellWord")||d.hasClass(b,"mceItemHidden"))&&(!a||d.decode(b.innerHTML)==a)&&d.remove(b,1)}),e.moveToBookmark(f)},_markWords:function(a){var c=this.editor,d=c.dom,e=c.getDoc(),f=c.selection,g=f.getBookmark(),h=[],i=a.join("|"),j=this._getSeparators(),k=new RegExp("(^|["+j+"])("+i+")(?=["+j+"]|$)","g");this._walk(c.getBody(),function(a){a.nodeType==3&&h.push(a)}),b(h,function(a){var b,c,f,g,h=a.nodeValue;if(k.test(h)){h=d.encode(h),c=d.create("span",{"class":"mceItemHidden"});if(tinymce.isIE){h=h.replace(k,"$1<mcespell>$2</mcespell>");while((g=h.indexOf("<mcespell>"))!=-1)f=h.substring(0,g),f.length&&(b=e.createTextNode(d.decode(f)),c.appendChild(b)),h=h.substring(g+10),g=h.indexOf("</mcespell>"),f=h.substring(0,g),h=h.substring(g+11),c.appendChild(d.create("span",{"class":"mceItemHiddenSpellWord"},f));h.length&&(b=e.createTextNode(d.decode(h)),c.appendChild(b))}else c.innerHTML=h.replace(k,'$1<span class="mceItemHiddenSpellWord">$2</span>');d.replace(c,a)}}),f.moveToBookmark(g)},_showMenu:function(a,d){var e=this,a=e.editor,f=e._menu,g,h=a.dom,i=h.getViewPort(a.getWin()),j=d.target;d=0,f||(f=a.controlManager.createDropMenu("spellcheckermenu",{"class":"mceNoIcons"}),e._menu=f);if(h.hasClass(j,"mceItemHiddenSpellWord"))return f.removeAll(),f.add({title:"spellchecker.wait","class":"mceMenuItemTitle"}).setDisabled(1),e._sendRPC("getSuggestions",[e.selectedLang,h.decode(j.innerHTML)],function(c){var d;f.removeAll(),c.length>0?(f.add({title:"spellchecker.sug","class":"mceMenuItemTitle"}).setDisabled(1),b(c,function(b){f.add({title:b,onclick:function(){h.replace(a.getDoc().createTextNode(b),j),e._checkDone()}})}),f.addSeparator()):f.add({title:"spellchecker.no_sug","class":"mceMenuItemTitle"}).setDisabled(1),a.getParam("show_ignore_words",!0)&&(d=e.editor.getParam("spellchecker_enable_ignore_rpc",""),f.add({title:"spellchecker.ignore_word",onclick:function(){var b=j.innerHTML;h.remove(j,1),e._checkDone(),d&&(a.setProgressState(1),e._sendRPC("ignoreWord",[e.selectedLang,b],function(b){a.setProgressState(0)}))}}),f.add({title:"spellchecker.ignore_words",onclick:function(){var b=j.innerHTML;e._removeWords(h.decode(b)),e._checkDone(),d&&(a.setProgressState(1),e._sendRPC("ignoreWords",[e.selectedLang,b],function(b){a.setProgressState(0)}))}})),e.editor.getParam("spellchecker_enable_learn_rpc")&&f.add({title:"spellchecker.learn_word",onclick:function(){var b=j.innerHTML;h.remove(j,1),e._checkDone(),a.setProgressState(1),e._sendRPC("learnWord",[e.selectedLang,b],function(b){a.setProgressState(0)})}}),f.update()}),g=c.getPos(a.getContentAreaContainer()),f.settings.offset_x=g.x,f.settings.offset_y=g.y,a.selection.select(j),g=h.getPos(j),f.showMenu(g.x,g.y+j.offsetHeight-i.y),tinymce.dom.Event.cancel(d);f.hideMenu()},_checkDone:function(){var a=this,c=a.editor,d=c.dom,e;b(d.select("span"),function(a){if(a&&d.hasClass(a,"mceItemHiddenSpellWord"))return e=!0,!1}),e||a._done()},_done:function(){var a=this,b=a.active;a.active&&(a.active=0,a._removeWords(),a._menu&&a._menu.hideMenu(),b&&a.editor.nodeChanged())},_sendRPC:function(b,c,d){var e=this;a.sendRPC({url:e.rpcUrl,method:b,params:c,success:d,error:function(a,b){e.editor.setProgressState(0),e.editor.windowManager.alert(a.errstr||"Error response: "+b.responseText)}})}}),tinymce.PluginManager.add("spellchecker",tinymce.plugins.SpellcheckerPlugin)})();